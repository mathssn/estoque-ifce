{% extends 'base.html' %}

{% block content %}


<div class="modal fade" id="cadastroAtaModal" tabindex="-1" aria-labelledby="cadastroAtaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
    <form action="{{ url_for('atas.cadastro_ata') }}" method="POST">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="cadastroAtaModalLabel">Cadastrar Ata</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
            <div class="mb-3">
                <label for="numero" class="form-label">Número</label>
                <input id="numero" name="numero" type="number" class="form-control" required>
            </div>
            
            <div class="mb-3">
                <label for="ano" class="form-label">Ano</label>
                <input id="ano" name="ano" type="number" class="form-control" required>
            </div>
            
            <div class="mb-3">
                <label for="fornecedor_id" class="form-label">Fornecedor</label>
                <select id="fornecedor_id" name="fornecedor_id" class="form-select">
                    {% for fornecedor_id, fornecedor in fornecedores.items() %}
                    {% if fornecedor.status.value == 'ativo' %}
                        <option value="{{ fornecedor_id }}">{{ fornecedor.nome }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="tipo" class="form-label">Tipo</label>
                <select id="tipo" name="tipo" class="form-select">
                    <option value="perecivel">Perecível</option>
                    <option value="nao_perecivel">Não Perecível</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            <button type="submit" class="btn btn-primary">Cadastrar</button>
        </form>
      </div>
    </div>
  </div>
</div>


<div>
  <a href="{{ url_for('main.atas_menu') }}" class="btn btn-secondary m-3">
    <i class="bi bi-arrow-left"></i>
  </a>
</div>


<div class="container py-4">
  <div class="page-title mb-4">
    <h2 class="fw-bold border-bottom pb-2">
      Atas
    </h2>
  </div>
</div>


<div class="container py-4">
<div class="card mb-3 shadow" style="border: 0px; border-radius: 15px;">
    <div class="card-body">
    <form id="formAta" action="{{ url_for('atas.listar_atas') }}" class="d-flex flex-column flex-md-row align-items-md-end justify-content-between gap-3 h-100">
        <div class="mb-3 flex-grow-1">
            <label for="fornecedor_select" class="form-label">Fornecedor</label>
            <select name="fornecedor_select" id="fornecedor_select" class="form-control h-100">
                {% for fornecedor_id, fornecedor_ in fornecedores.items() %}
                    {% if fornecedor_id == fornecedor.id %}
                        <option value="{{ fornecedor.id }}" selected>{{ fornecedor.nome }}</option>
                    {% else %}
                        <option value="{{ fornecedor_id }}">{{ fornecedor_.nome }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>
        <div class="mb-3 flex-grow-1">
            <label for="tipo_select" class="form-label">Tipo</label>
            <select name="tipo_select" id="tipo_select" class="form-control h-100">
                <option value="" {% if tipo == "" %}selected{% endif %}>-</option>
                <option value="perecivel" {% if tipo == "perecivel" %}selected{% endif %}>Perecível</option>
                <option value="nao_perecivel"{% if tipo == "nao_perecivel" %}selected{% endif %}>Não Perecível</option>
            </select>
        </div>
        <div class="mb-3 flex-grow-1">
            <label for="ano_input" class="form-label">Ano</label>
            <input type="number" id="ano_input" name="ano_input" class="form-control" value="{{ ano }}">
        </div>
        <div class="mb-3">
            <button class="btn btn-primary h-100" type="submit">Pesquisar</button>
        </div>

    </form>
</div>
</div>
</div>


{% if ['admin', 'nutricionista', 'financeiro'] | check_intersection(session.get('roles')) %}
<div style="display: flex; justify-content: center; margin-bottom: 15px;">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#cadastroAtaModal">
        Cadastrar nova ata
    </button>
</div>
{% endif %}

<div class="container mt-5">
<div class="card mb-3 shadow" style="border: 0px; padding: 30px; border-radius: 15px;">
    <div class="card-body">
    <div class="table-responsive">

        <table class="table table-hover">
        <thead>
            <tr>
                <th scope="col">Número</th>
                <th scope="col">Ano</th>
                <th scope="col">Fornecedor</th>
                <th scope="col">Tipo</th>
                <th scope="col">Status</th>
                <th scope="col">Ações</th>
            </tr>
        </thead>
        
        <tbody>

            {% for ata in atas %}
            {% if ata.numero != 0 %}
                <tr>
                    <td scope="row"><a href="{{ url_for('atas.ata_info', ata_id=ata.id) }}" style="text-decoration: none;">{{ ata.numero }}</a></td>
                    <td>{{ ata.ano }}</td>
                    <td>{{ fornecedores.get(ata.fornecedor_id).nome }}</td>
                    <td>{{ ata.tipo.value | replace('_', ' ') | capitalize }}</td>
                    <td>{{ ata.status.value | capitalize }}</td>
                    <td style="display: flex; gap: 10px;">
                        {% if ['admin', 'nutricionista', 'financeiro'] | check_intersection(session.get('roles')) %}
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editAtaModal" onclick="fillEditForm('{{ata.id}}', '{{ata.numero}}', '{{ata.ano}}', '{{ata.fornecedor_id}}', '{{ata.tipo.value}}', '{{ata.status.value}}')">Editar</button>
                        {% else %}
                            <button class="btn btn-secondary" onclick="alert('Você não tem permissão para editar este item.')">Editar</button>
                        {% endif %}
                    </td>
                </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>
</div>
</div>
</div>

<div class="modal fade" id="editAtaModal" tabindex="-1" aria-labelledby="editAtaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
    <form id="editAtaForm" method="POST">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="editAtaModalLabel">Editar Ata</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
            <div class="mb-3">
                <label for="edit_numero" class="form-label">Numero</label>
                <input id="edit_numero" name="edit_numero" type="number" class="form-control">
            </div>
            
            <div class="mb-3">
                <label for="edit_ano" class="form-label">Ano</label>
                <input id="edit_ano" name="edit_ano" type="number" class="form-control">
            </div>
            
            <div class="mb-3">
                <label for="edit_fornecedor_id" class="form-label">Fornecedor</label>
                <select name="edit_fornecedor_id" id="edit_fornecedor_id" class="form-select">
                    {% for fornecedor_id, fornecedor in fornecedores.items() %}
                    {% if fornecedor.status.value == 'ativo' %}
                        <option value="{{ fornecedor_id }}">{{ fornecedor.nome }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="edit_tipo" class="form-label">Tipo</label>
                <select id="edit_tipo" name="edit_tipo" class="form-select">
                    <option value="perecivel">Perecível</option>
                    <option value="nao_perecivel">Não Perecível</option>
                </select>
            </div>
            
            <div class="mb-3">
                <label for="edit_status" class="form-label">Status</label>
                <select id="edit_status" name="edit_status" class="form-select">
                    {% for st in ['ativo', 'inativo'] %}
                        <option value="{{ st }}">{{ st | capitalize }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            <button type="submit" class="btn btn-primary">Salvar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
    function fillEditForm(id, numero, ano, fornecedor_id, tipo, status) {
        document.getElementById("edit_numero").value = numero;
        document.getElementById("edit_ano").value = ano;
        document.getElementById("edit_fornecedor_id").value = fornecedor_id;
        document.getElementById("edit_tipo").value = tipo;
        document.getElementById("edit_status").value = status;

        document.getElementById("editAtaForm").action = "{{ url_for('atas.editar_ata', ata_id=0) }}".replace('0', id);
    }
</script>

    
{% endblock %}