{% extends 'base.html' %}

{% block content %}



<div class="container py-4">
  <div class="page-title mb-4">
    <h2 class="fw-bold border-bottom pb-2">
      Empenhos
    </h2>
  </div>
</div>


<div class="container py-4">
<div class="card mb-3 shadow" style="border: 0px; border-radius: 15px;">
    <div class="card-body">
    <form id="formEmpenho" action="{{ url_for('empenhos.form_empenhos_lista') }}" class="d-flex flex-column flex-md-row align-items-md-end justify-content-between gap-3 h-100" method="post">
        <div class="mb-3 flex-grow-1">
            <label for="fornecedor_select" class="form-label">Fornecedor</label>
            <select name="fornecedor_select" id="fornecedor_select" class="form-control h-100">
                {% for fornecedor_id, fornecedor_ in fornecedores.items() %}
                    {% if fornecedor_id == fornecedor.id %}
                        <option value="{{ fornecedor.id }}" selected>{{ fornecedor.nome }}</option>
                    {% else %}
                        <option value="{{ fornecedor_id }}">{{ fornecedor_.nome }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>
        <div class="mb-3 flex-grow-1">
            <label for="ano_input" class="form-label">Ano</label>
            <input type="number" id="ano_input" name="ano_input" class="form-control" value="{{ ano }}">
        </div>
        <div class="mb-3">
            <button class="btn btn-primary h-100" type="submit">Pesquisar</button>
        </div>

    </form>
</div>
</div>
</div>


<div class="container mt-5">
<div class="card mb-3 shadow" style="border: 0px; padding: 30px; border-radius: 15px;">
    <div class="card-body">
    <div class="table-responsive">

        <table class="table table-hover">
        <thead>
            <tr>
                <th scope="col">Número</th>
                <th scope="col">Ano</th>
                <th scope="col">Fornecedor</th>
                <th scope="col">Status</th>
                <th scope="col">Ações</th>
            </tr>
        </thead>
        
        <tbody>

            {% for empenho in empenhos %}
            {% if empenho.numero != 0 %}
                <tr>
                    <td scope="row"><a href="{{ url_for('empenhos.empenho_info', empenho_id=empenho.id, origem='empenhos') }}" style="text-decoration: none;">{{ empenho.numero }}</a></td>
                    <td>{{ empenho.ano }}</td>
                    <td>{{ fornecedores.get(empenho.fornecedor_id).nome }}</td>
                    <td>{{ empenho.status.value | capitalize }}</td>
                    <td style="display: flex; gap: 10px;">
                        {% if ['admin', 'nutricionista', 'financeiro'] | check_intersection(session.get('roles', [])) and atas.get(empenho.ata_id) and atas.get(empenho.ata_id).status.value == 'ativo' %}
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editEmpenhoModal" onclick="fillEditForm('{{empenho.id}}', '{{empenho.numero}}', '{{empenho.ano}}', '{{empenho.fornecedor_id}}', '{{empenho.status.value}}')">Editar</button>
                        {% else %}
                            <button class="btn btn-secondary">Editar</button>
                        {% endif %}
                    </td>
                </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>
</div>
</div>
</div>


<div class="modal fade" id="editEmpenhoModal" tabindex="-1" aria-labelledby="editItemEmpenhoLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="editEmpenhoForm" method="POST">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="editEmpenhoModalLabel">Editar Empenho</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

          <div class="mb-3">
            <label for="edit_numero" class="form-label">Número</label>
            <input id="edit_numero" name="edit_numero" type="number" class="form-control">
          </div>

          <div class="mb-3">
            <label for="edit_ano" class="form-label">Ano</label>
            <input id="edit_ano" name="edit_ano" type="number" class="form-control" required>
          </div>

          <div class="mb-3">
            <label for="edit_fornecedor" class="form-label">Fornecedor</label>
            <select id="edit_fornecedor" name="edit_fornecedor" class="form-select" disabled>
              {% for fornecedor_id, fornecedor in fornecedores.items() %}
                <option value="{{ fornecedor_id }}">{{ fornecedor.nome }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label for="edit_status" class="form-label">Status</label>
            <select id="edit_status" name="edit_status" class="form-select" required>
              <option value="ativo">Ativo</option>
              <option value="inativo">Inativo</option>
            </select>

          </div>

          <input type="hidden" name="fornecedor_id" id="fornecedor_id">

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
    function fillEditForm(id, numero, ano, fornecedor_id, status) {
        document.getElementById("edit_numero").value = numero;
        document.getElementById("edit_ano").value = ano;
        document.getElementById("edit_fornecedor").value = fornecedor_id;
        document.getElementById("edit_status").value = status;

        document.getElementById("editEmpenhoForm").action = "{{ url_for('empenhos.editar_empenho', empenho_id=0, origem='empenhos') }}".replace('0', id);
    }
    
</script>

{% endblock %}
